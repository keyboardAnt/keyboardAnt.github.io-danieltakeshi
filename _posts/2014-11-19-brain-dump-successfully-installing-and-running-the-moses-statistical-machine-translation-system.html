---
layout: post
title: 'Brain Dump: Successfully Installing and Running the Moses Statistical Machine
  Translation System'
date: 2014-11-19 16:52:26.000000000 -08:00
categories:
- Computer Science
tags:
- boost
- homebrew
- mgiza
- Moses
- natural language processing
- statistical machine translation
status: publish
type: post
published: true
meta:
  _edit_last: '25629085'
  _oembed_cd4f6760edd1faee3a985420bb2f4299: '{{unknown}}'
  geo_public: '0'
  _publicize_pending: '1'
  _wpas_skip_facebook: '1'
  _wpas_skip_google_plus: '1'
  _wpas_skip_twitter: '1'
  _wpas_skip_linkedin: '1'
  _wpas_skip_tumblr: '1'
  _wpas_skip_path: '1'
author:
  login: seitad
  email: takeshidanny@gmail.com
  display_name: Daniel Seita
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>I'm using <a href="http://www.statmt.org/moses/">Moses</a> again. It's an open-source statistical machine translation system. I first used it when I was <a href="https://seitad.wordpress.com/2012/07/27/wrapping-up-my-summer-research/">at Bard in 2012</a>, and I remember being clueless about the installation process and being overwhelmed by all the Linux/Unix commands I had to know. I think it took me more than a <em>week</em> before I had installed Moses and successfully completed the <a href="http://www.statmt.org/moses/?n=Moses.Baseline">suggested baseline test</a>. At that time, I was doing nothing <em>but</em> that ... so I was pretty frustrated. Even at the end of my REU, the commands to run Moses felt like black magic.</p>
<p>But I'm back at it again. Armed with several more years of hacking and Linux/Unix experience, as well as a <a href="http://www.cs.berkeley.edu/~klein/cs288/fa14/">statistical natural language processing class</a> for background material, I managed to install Moses and complete the baseline test on my laptop, which is a Macbook that I got last January. It still took me almost a week (Friday night, 9-5 Saturday, 9-5 Sunday, all day Monday and Tuesday...) to do that since I ran into some unexpected problems. To prevent me from getting this kind of headache again, I'll be listing the steps I conducted to install and run the baseline, which hopefully will be applicable for anyone trying to use Moses right now. If you find this article useful, please let me know. (Keep in mind, however, that it will probably be obsolete in a few months.) You will need some Linux/Unix experience to follow this article.</p>
<p><!--more--></p>
<p>At a high level, I had problems with installing <a href="http://www.boost.org/">boost</a>, installing <a href="https://github.com/moses-smt/mgiza">mgiza</a>, and training the baseline system.</p>
<p>To start, I git cloned the moses code. The <a href="http://www.statmt.org/moses/?n=Development.GetStarted">installation instructions say</a> that I need g++ and boost installed. Actually, I don't think g++ is necessary because in Mavericks (i.e., OS X 10.9), Apple changed the default compiler for C++ to be clang, so we really need <em>that</em> on our computers to run Moses, but clang should be built-in or be part of Xcode so it should definitely be there as long as I have Xcode. Speaking of boost, I did have boost 1.56 installed; I got it via the command</p>
<p>[code]</p>
<p>brew install boost</p>
<p>[/code]</p>
<p>which will install boost 1.56 in the directory</p>
<p>[code]</p>
<p>/usr/local/Cellar/boost/</p>
<p>[/code]</p>
<p>because that's the default place where <a href="http://brew.sh/">homebrew</a> installs things. For example, I also have the widely-used <a href="http://www.numpy.org/">numpy</a> package located in /usr/local/Cellar/numpy.</p>
<p>So, thinking that I had things taken care of, I went into my mosesdecoder directory, and followed the instructions by running ./bjam -j8. Unfortunately, I ran into the dreaded "clang: error: linker command failed with exit code 1."</p>
<p>[code]</p>
<p>$ ./bjam -j8<br />
Tip: install tcmalloc for faster threading. See BUILD-INSTRUCTIONS.txt for more information.<br />
mkdir: bin: File exists<br />
...patience...<br />
...patience...<br />
...found 4469 targets...<br />
...updating 155 targets...<br />
darwin.link lm/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/query<br />
ld: library not found for -lboost_thread<br />
clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
<p>// Additional error messages...</p>
<p>...failed darwin.link mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/util_test...<br />
...skipped &amp;lt;pmert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi&amp;gt;util_test.passed for lack of &amp;lt;pmert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi&amp;gt;util_test...<br />
darwin.link mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/vocabulary_test<br />
ld: library not found for -lboost_thread<br />
clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
<p>&amp;quot;g++&amp;quot; -o &amp;quot;mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/vocabulary_test&amp;quot; &amp;quot;mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/VocabularyTest.o&amp;quot; &amp;quot;mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/libmert_lib.a&amp;quot; -lboost_unit_test_framework -llzma -lbz2 -ldl -lboost_system -lz -lboost_thread -lm -liconv -g -Wl,-dead_strip -no_dead_strip_inits_and_terms<br />
...failed darwin.link mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/vocabulary_test...<br />
...skipped &amp;lt;pmert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi&amp;gt;vocabulary_test.passed for lack of &amp;lt;pmert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi&amp;gt;vocabulary_test...<br />
...failed updating 72 targets...<br />
...skipped 83 targets...<br />
The build failed. If you need support, run:<br />
./jam-files/bjam -j8 --debug-configuration -d2 |gzip &amp;gt;build.log.gz<br />
then attach build.log.gz to your e-mail.<br />
You MUST do 3 things before sending to the mailing list:<br />
1. Subscribe to the mailing list at http://mailman.mit.edu/mailman/listinfo/moses-support<br />
2. Attach build.log.gz to your e-mail<br />
3. Say what is the EXACT command you executed when you got the error</p>
<p>[/code]</p>
<p>Huh. I can't even do a simple installation?!? Note: in the above terminal output, I included my original command (after the dollar sign $), and the error message was much longer than what's displayed; I got rid of some if it with "// Additional error messages" for clarity.</p>
<p>What's the problem? Apparently, moses couldn't find the lboost_thread library. After some extensive research on Google and asking on the Moses mailing list, I think the issue comes down to the layout being "layout=tagged" versus "layout-system". To give an example, the library file that I think lboost_thread refers to is libboost_thread-mt.a, which is a "tagged" version due to having "mt"; the untagged file version would be libboost_thread.a. I <em>think</em> this was the problem I was getting, but I couldn't figure it out despite making moses look at the directory where boost was installed. On the instructions, they say to do:</p>
<p>[code]</p>
<p>./bjam --with-boost=~/workspace/temp/boost_1_55_0 -j8</p>
<p>[/code]</p>
<p>where the workspace/temp folder is just where they've put boost in. On my system, it's obviously in a different location, so I ran</p>
<p>[code]</p>
<p>./bjam --with-boost=/usr/local/Cellar/boost -j8</p>
<p>[/code]</p>
<p>But that also didn't work. Note: the tilda option indicates the path to the home directory, so on my computer, ~/workspace would be equivalent to /Users/danielseita/workspace. The /Users/danielseita equals the $HOME path variable.</p>
<p>I asked on the mailing list, and their advice was to do some clean installations because it's obvious something was broken here, especially with boost. All right, then, the first step to do that is to uninstall boost:</p>
<p>[code]</p>
<p>brew uninstall boost --force</p>
<p>[/code]</p>
<p>I went through several more trials of installing boost via homebrew before I decided to avoid using it at all; I went to the boost website directly, downloaded the .tar.gz file for version 1.57 (the latest version at the time of this writing), and untarred it.</p>
<p>[code]</p>
<p>tar -zxvf boost_1_57_0.tar.gz</p>
<p>[/code]</p>
<p>That pastes the boost files in the current directory, but now we have to <em>compile</em> it for Moses. At the time of this writing, the Moses installation instructions say to execute the following two commands in the boost directory:</p>
<p>[code]</p>
<p>./bootstrap.sh<br />
./b2 -j8 --prefix=$PWD --libdir=$PWD/lib64 --layout=system link=static install || echo FAILURE</p>
<p>[/code]</p>
<p>Unfortunately, running those commands never helped, and I consistently got the same amount of errors/warnings each time. After a series of uninstallations/installations, I decided to just try following the instructions directly from the boost website, specifically from their "<a href="http://www.boost.org/doc/libs/1_57_0/more/getting_started/unix-variants.html">Getting Started</a>" section. I attempted the following set of commands from a clean download folder boost_1_57_0:</p>
<p>[code]<br />
cp -r boost_1_57_0/ /usr/local<br />
cd /usr/local/boost_1_57_0<br />
./bootstrap.sh<br />
./b2 install<br />
[/code]</p>
<p><em>And in addition to that</em> ... I went into Apple's Finder window, double-clicked on the Xcode application (just to check if I had clang installed) ... and upon doing so, I received a pop-up message saying that there was some external software I needed to install! I wish I had gotten a screenshot of that, but it showed up as soon as I double clicked on the application, and in a few seconds it had installed what it needed. It looked like I did have clang installed, but I have no idea about how much that initial pop-up must have helped me.</p>
<p>I then tried to compile moses again with a simple ./bjam -j8 command. Aaaaaand ... it worked! See some of the output (again, the dollar sign indicates lines that I typed):</p>
<p>[code]</p>
<p>$ cd ~/mosesdecoder/<br />
$ ./bjam -j8<br />
Tip: install tcmalloc for faster threading. See BUILD-INSTRUCTIONS.txt for more information.<br />
mkdir: bin: File exists<br />
...patience...<br />
...patience...<br />
...found 4470 targets...<br />
...updating 63 targets...<br />
common.copy /Users/danielseita/mosesdecoder/bin/lmplz<br />
darwin.link util/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/bit_packing_test<br />
darwin.link util/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/multi_intersection_test<br />
darwin.link util/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/joint_sort_test<br />
darwin.link util/bin/file_piece_test.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/file_piece_test<br />
darwin.link lm/bin/partial_test.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/partial_test<br />
darwin.link lm/bin/left_test.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/left_test<br />
darwin.link lm/bin/model_test.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/model_test<br />
testing.unit-test util/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/joint_sort_test.passed<br />
Running 4 test cases...</p>
<p>*** No errors detected<br />
testing.unit-test util/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/multi_intersection_test.passed<br />
Running 4 test cases...</p>
<p>// Additional cases not shown</p>
<p>*** No errors detected<br />
testing.unit-test mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/util_test.passed<br />
Running 3 test cases...</p>
<p>*** No errors detected<br />
testing.unit-test mert/bin/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/vocabulary_test.passed<br />
Running 2 test cases...</p>
<p>*** No errors detected<br />
testing.capture-output moses/LM/bin/BackwardTest.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/BackwardTest.run<br />
**passed** moses/LM/bin/BackwardTest.test/darwin-4.2.1/release/debug-symbols-on/link-static/threading-multi/BackwardTest.test<br />
...updated 63 targets...<br />
SUCCESS</p>
<p>[/code]</p>
<p>What's the lesson here? I guess the point is that <em>deleting stuff and just starting an installation process all over again while trying out new ways of doing things is one of the most effective techniques to tackling complicated software problems</em>. Yeah, it's kind of lame, but I guess trial-and-error is the <em>nature</em> of Linux/Unix.</p>
<p>All right, now let's discuss the <em>second</em> main problem I had with installing Moses, this time related to mgiza. I initially ran into the problems that I will describe below, but the fix above (uninstalling boost, taking it from the website, and compiling it according to the boost website's instructions) seemed to resolve them. But I will describe the problem I had with mgiza just for completeness.</p>
<p>On the Moses website, they now recommend avoiding GIZA++ (which is a popular word-alignment software) and instead using mgiza, which is a multi-threaded version of GIZA++. As with moses, I git cloned it into a directory. The installation instructions are really simple, since mgiza comes with makefiles (the cmake command will generate a Makefile). There are three commands to execute:</p>
<p>[code]</p>
<p>cmake .<br />
make<br />
make install</p>
<p>[/code]</p>
<p>Notice that cmake has a period after it, which indicates that we're assuming the installation happens in the <em>current directory</em>.</p>
<p>Of course, despite the simplicity of these instructions, I still got errors. The cmake step seemed to work fine, but not make:</p>
<p>[code]</p>
<p>1 warning generated.<br />
Linking CXX executable ../bin/d4norm<br />
Undefined symbols for architecture x86_64:<br />
&amp;quot;std::string::_Rep::_M_destroy(std::allocator&amp;lt;char&amp;gt; const&amp;amp;)&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
&amp;quot;std::string::_Rep::_S_empty_rep_storage&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
&amp;quot;std::string::assign(char const*, unsigned long)&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
&amp;quot;std::basic_string&amp;lt;char, std::char_traits&amp;lt;char&amp;gt;, std::allocator&amp;lt;char&amp;gt; &amp;gt;::basic_string(char const*, std::allocator&amp;lt;char&amp;gt; const&amp;amp;)&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
&amp;quot;std::basic_string&amp;lt;char, std::char_traits&amp;lt;char&amp;gt;, std::allocator&amp;lt;char&amp;gt; &amp;gt;::basic_string(std::string const&amp;amp;)&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
&amp;quot;std::basic_string&amp;lt;char, std::char_traits&amp;lt;char&amp;gt;, std::allocator&amp;lt;char&amp;gt; &amp;gt;::~basic_string()&amp;quot;, referenced from:<br />
boost::system::(anonymous namespace)::generic_error_category::message(int) const in libboost_system-mt.a(error_code.o)<br />
ld: symbol(s) not found for architecture x86_64<br />
clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
<p>[/code]</p>
<p>Yikes ... another problem with boost! And this time, the "ld: symbols(s) not found for architecture x86_64" error occurred. Again, as I mentioned earlier, the solution lies not with mgiza itself but with boost (where it's installed, etc.), so consider a clean installation and compilation of boost from the official website (not homebrew). When I did that, I deleted the mgiza directory, cloned it again from git, and the three subsequent commands worked. I got a ton of warning messages, <em>but no errors,</em> which is the important part.</p>
<p>Whew! With moses and mgiza successfully compiled, I could <em>finally</em> start the baseline! Most of the time, copying and pasting the instructions from the Moses website and modifying them according to your directory structure should work, but there are some important things to be aware of:</p>
<p>(1) Installing irstlm is a little different because now it's version 5.80.06 rather than the 5.80.03 that's currently listed on the website. (In fact, irstlm 5.80.03 does not even compile on my laptop.) With this new version, irstlm moved the directory structure so now the installation won't work if you copy the baseline. There's a README in the "trunk" directory inside irstlm so I followed that and didn't seem to have many issues. Make sure you modify the rest of the baseline's commands accordingly, since the documentation assumes that we use ~/irstlm/bin as the place where the binaries are located.</p>
<p>(2) One thing I had trouble with was the "--text yes" option for the compile-lm. That created a "DEBUG: warning: too many parameters" output, <a href="http://comments.gmane.org/gmane.comp.nlp.moses.user/9924">as described here</a>. The key is to use "--text=yes" so <strong>put in the equals sign</strong>. I can't believe that fix took so long for me to figure out! I described this on the mailing list and the people maintaining the Moses website have (as of this writing) changed the instructions to conform to "--text=yes".</p>
<p>(3) With training, the current instructions assume we're using GIZA++, but since it's mgiza, we've got to change that. Oh, that reminds me -- I also tried out these training steps with normal GIZA++, but I could never get it work because after training went on for a few hours, something wrong happened with the lexical reordering score, because extract.o.sorted.gz never got generated. Here's the error I got in the log file training.out:</p>
<p>[code]</p>
<p>libc++abi.dylib: terminating with uncaught exception of type \<br />
util::ErrnoException: util/file.cc:68 in int util::OpenReadOrThrow(const char *) \<br />
threw ErrnoException because `-1 == (ret = open(name, 0x0000))'.</p>
<p>No such file or directory while opening \<br />
/Users/danielseita/working/train/model/extract.o.sorted.gz</p>
<p>ERROR: Execution of: \<br />
/Users/danielseita/mosesdecoder/scripts/../bin/lexical-reordering-score \<br />
/Users/danielseita/working/train/model/extract.o.sorted.gz 0.5 \<br />
/Users/danielseita/working/train/model/reordering-table. \<br />
--model &amp;quot;wbe msd wbe-msd-bidirectional-fe&amp;quot;</p>
<p>died with signal 6, without coredump</p>
<p>[/code]</p>
<p>The error above prevented a moses.ini file from even forming. To work around this issue, it's possible to run the training while removing the -reordering argument, but when I did that, tuning fails. If you know of a fix, please let me know!</p>
<p>Now back to training with mgiza. The instructions are listed on the <a href="http://www.statmt.org/moses/?n=Moses.ExternalTools">external software page</a>. We need to specify the -mgiza flag, and we also need to make sure that -external-bin-dir is set correctly. This should be a directory where the mgiza <em>binary </em>files are located, <em>as well as </em>the merge_align.py script (all of these must be in one directory together!). In the current version of mgiza, they seem to be in /mgiza/mgizapp/bin. I decided to move everything over to a directory called "word_align_tools" inside the mosesdecoder directory. I also specified the number of cpus for mgiza to be four. The following code shows the list of commands I used to <em>prepare</em> my file system for training:</p>
<p>[code]</p>
<p>cd ~/mosesdecoder/<br />
mkdir word_align_tools<br />
cp ~/mgiza/mgizapp/bin/* word_align_tools/<br />
cp ~/mgiza/mgizapp/scripts/merge_alignment.py word_align_tools/</p>
<p>[/code]</p>
<p>And this does the actual training:</p>
<p>[code]</p>
<p>/Users/danielseita/mosesdecoder/scripts/training/train-model.perl \<br />
-root-dir /Users/danielseita/working/train \<br />
-corpus /Users/danielseita/corpus/news-commentary-v8.fr-en.clean \<br />
-f fr -e en -alignment grow-diag-final-and -reordering msd-bidirectional-fe \<br />
-lm 0:3:/Users/danielseita/lm/news-commentary-v8.fr-en.blm.en \<br />
-mgiza -mgiza-cpus 4<br />
-external-bin-dir /Users/danielseita/mosesdecoder/mgiza_tools/ &amp;gt;&amp;amp;training.out</p>
<p>[/code]</p>
<p>I put in some backward slashes \ there just so the code wouldn't require so much scrolling to understand, but I didn't include them when I ran it in Terminal. Also notice that I'm using <strong>absolute paths</strong>, rather than relative paths. This means we want a full path like /Users/danielseita/mosesdecoder instead of ~/mosesdecoder. I saw some errors online that were resolved with using full paths, so I decided to use full paths for <em>everything</em>, though it's probably worth it only for the -root-dir argument above. Finally, I'm not adding in a ":8" to the language model argument, because I don't know what that does (to do: find out!).</p>
<p><strong>Update 11/29/14: </strong>Apparently, that extra :8 argument forces the use of KenLM instead of SRILM ... so yes, include an extra :8 after the language model file name. The above command, while still correct I believe, should not be used.</p>
<p>That command above took five or six hours to complete on my laptop, which is surprising because the baseline currently claims it should be 1.5 hours, and I've got a pretty powerful laptop. Perhaps the data I downloaded got updated and is larger than the baseline claims? Or maybe it's an mgiza issue?</p>
<p>Once training is done, here's a <em>very</em> important piece of advice: <strong>change the resulting moses.ini file to say KENLM instead of SRILM</strong>. This means my moses.ini file had a line that looked like this:</p>
<p>[code]</p>
<p>KENLM name=LM0 factor=0 path=/Users/danielseita/lm/newscommentary-v8.fr-en.blm.en order=3</p>
<p>[/code]</p>
<p>I'm not sure why this isn't emphasized that much on the baseline webpage, because it's pretty darn important! The tuning will fail if we don't get the language model set correctly.</p>
<p>(4) I ran into many problems with tuning, but most of them were "carried over" from the training step, such as if I made an error in the command for training. Once I finally got mgiza working, tuning was fine, and the following command (for tuning) ran in the normal time range, which is about four hours.</p>
<p>[code]</p>
<p>/Users/danielseita/mosesdecoder/scripts/training/mert-moses.pl \<br />
/Users/danielseita/corpus/news-test2008.true.fr \<br />
/Users/danielseita/corpus/news-test2008.true.en \<br />
/Users/danielseita/mosesdecoder/bin/moses \<br />
/Users/danielseita/working/train/model/moses.ini --decoder-flags=&amp;quot;-threads 4&amp;quot; \<br />
--mertdir /Users/danielseita/mosesdecoder/bin/ &amp;gt;&amp;amp; mert.out</p>
<p>[/code]</p>
<p>(5) Testing should proceed as normal. My BLEU score is 23.58, which is what they expect (they say they got 23.5).</p>
<p>[code]</p>
<p>$ ~/mosesdecoder/scripts/generic/multi-bleu.perl -lc \<br />
~/corpus/newstest2011.true.en &amp;lt; newstest2011.translated.en<br />
BLEU = 23.58, 60.3/29.9/16.9/10.1 (BP=1.000, ratio=1.017, hyp_len=76035, ref_len=74753)</p>
<p>[/code]</p>
<p>Looking back at this, while Moses is no doubt a great software system, it <em>does</em> take a lot of effort to get it working correctly. Sometime in the next few weeks, I'll try to post a real, organized guide here.</p>
